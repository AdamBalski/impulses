@startuml
actor User
participant "Impulses UI" as UI
participant "Impulses Server" as Server
participant "Google OAuth2" as OAuth2
participant "Google Calendar API" as GCal
database "Persistent Datastore" as DB

== OAuth2 Flow ==
User -> UI : Click "Connect Google Calendar"
UI -> Server : GET /oauth2/google/auth (X-Data-Token)
Server -> UI : {"url": "..."}
UI -> OAuth2 : Browser navigates to url
User -> OAuth2 : Authorize app
OAuth2 -> Server : GET /oauth2/google/callback?code=...&state=...
Server -> OAuth2 : Exchange code for tokens
OAuth2 -> Server : Return tokens
Server -> DB : Store credentials under gcal/tokens/{token_id}/credentials
Server -> UI : Redirect to /tokens?google_oauth2=authorized|error
== gCal polling job (runs every five minutes; also runs once at startup) ==
Server -> GCal : Fetch events using stored credentials
GCal -> Server : Return events (e.g. summary: "#!running", description: "distance=10000")
Server -> DB : Store events as metrics

== Integration status ==
UI -> Server : GET /oauth2/google/configs (X-Data-Token)
Server -> DB : Read credentials + sync state
Server --> UI : JSON configs

== REST API usage ==
User -> Server : GET /data/imp.events.duration
Server -> DB : Read metrics
DB --> Server : Return duration metric
Server --> User : JSON metrics

User -> Server : GET /data/imp.events.custom.distance
Server -> DB : Read metrics
DB --> Server : Return custom distance metric
Server --> User : JSON metrics
@enduml

